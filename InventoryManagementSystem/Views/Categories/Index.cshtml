@{
    ViewData["Title"] = "Categories";
}
<!-- Toast container (top right) -->
<div id="liveToast"
     class="toast align-items-center bg-success text-white border-0 mt-5"
     role="alert" aria-live="assertive" aria-atomic="true"
     data-bs-autohide="true" data-bs-delay="3000">
    <div class="d-flex">
        <div class="toast-body" id="toastMessage"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
</div>




<div class="container my-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary"><i class="bi bi-tags me-2"></i>Categories</h2>
        <button class="btn btn-success shadow-sm" onclick="openAddCategoryModal()">
            <i class="bi bi-plus-circle me-1"></i> Add Category
        </button>
    </div>

    <!-- Table Card -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0" id="categoryTable">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Name</th>
                        <th scope="col">Description</th>
                        <th scope="col" class="text-center">Products</th>
                        <th scope="col" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Filled via AJAX -->
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
            <form id="categoryForm">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="categoryModalTitle"><i class="bi bi-pencil-square me-1"></i> Add Category</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="categoryId" />
                    <div class="mb-3">
                        <label for="categoryName" class="form-label fw-semibold">Name</label>
                        <input type="text" id="categoryName" class="form-control" placeholder="Enter category name">
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label fw-semibold">Description</label>
                        <textarea id="categoryDescription" class="form-control" placeholder="Enter description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="btnSaveCategory" class="btn btn-primary shadow-sm">
                        <i class="bi bi-save me-1"></i> Save
                    </button>
                    <button type="button" class="btn btn-secondary shadow-sm" data-bs-dismiss="modal">Close</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Normal delete modal -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-1"></i> Delete Category</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Are you sure you want to delete this category? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnConfirmDeleteCategory" class="btn btn-danger shadow-sm">
                    <i class="bi bi-trash me-1"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary shadow-sm" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete with products modal -->
<div class="modal fade" id="deleteCategoryWithProductsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-exclamation-octagon me-1"></i> Warning</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteWithProductsMessage" class="fw-bold text-danger"></p>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnConfirmDeleteWithProducts" class="btn btn-danger shadow-sm">
                    Move & Delete
                </button>
                <button type="button" class="btn btn-secondary shadow-sm" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


<!-- Category Details Modal -->
<div class="modal fade" id="categoryDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="categoryDetailsTitle"><i class="bi bi-info-circle me-1"></i> Category Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="categoryDetailsBody">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>


        // Open Add Modal
        function openAddCategoryModal() {
            $('#categoryModalTitle').text('Add Category');
            $('#categoryId').val(0);
            $('#categoryName').val('');
            $('#categoryDescription').val('');
            var modal = new bootstrap.Modal(document.getElementById('categoryModal'));
            modal.show();
        }

        // Open Edit Modal
        function openEditCategoryModal(id, name, description) {
            $('#categoryModalTitle').text('Edit Category');
            $('#categoryId').val(id);
            $('#categoryName').val(name);
            $('#categoryDescription').val(description);
            var modal = new bootstrap.Modal(document.getElementById('categoryModal'));
            modal.show();
        }

        // Open Delete Modal
               let deleteCategoryId = 0;

        function openDeleteCategoryModal(id) {
            deleteCategoryId = id;

            $.get('/Categories/CheckCategoryProducts/' + id, function (res) {
                if (res.productCount > 0) {
                    // Show warning modal
                    $('#deleteWithProductsMessage').text(
                        `This category has ${res.productCount} product(s). Move them to 'Uncategorized' first, then confirm delete.`
                    );

                    var modalEl = document.getElementById('deleteCategoryWithProductsModal');
                    if (!modalEl.modalInstance) modalEl.modalInstance = new bootstrap.Modal(modalEl);
                    modalEl.modalInstance.show();

                } else {
                    // Normal delete modal
                    var modalEl = document.getElementById('deleteCategoryModal');
                    if (!modalEl.modalInstance) modalEl.modalInstance = new bootstrap.Modal(modalEl);
                    modalEl.modalInstance.show();
                }
            });
        }

                // Confirm delete for category with products
        $('#btnConfirmDeleteWithProducts').click(function () {
            $.post('/Categories/DeleteWithMove/' + deleteCategoryId, function (res) {
                if (res.success) {
                    $('.modal').modal('hide');

                    // Reload the category table
                    loadCategories(); // <-- make sure this fetches all categories again

                    showToast(`Category deleted. ${res.movedProducts} product(s) moved to 'Uncategorized'.`, "success");
                } else {
                    showToast(res.error || "Error deleting category", "error");
                }
            }).fail(function () {
                showToast("Server error occurred while deleting category.", "error");
            });
        });

        // Confirm delete for normal category
        $('#btnConfirmDeleteCategory').click(function () {
            $.post('/Categories/DeleteAjax/' + deleteCategoryId, function (res) {
                if (res.success) {
                    $('#row_' + deleteCategoryId).remove();
                    $('.modal').modal('hide');
                    showToast("Category deleted successfully.", "success");
                } else {
                    showToast(res.error || "Error deleting category", "error");
                }
            });
        });


        function openCategoryDetailsModal(id) {
            $.get('/Categories/GetById/' + id, function(c) {
                let productsHtml = '';
                if (c.products && c.products.length > 0) {
                    productsHtml = '<ul class="list-group">';
                    c.products.forEach(p => {
                        productsHtml += `<li class="list-group-item">${p.name}</li>`;
                    });
                    productsHtml += '</ul>';
                } else {
                    productsHtml = '<p class="text-muted">No products in this category.</p>';
                }

                var html = `
                    <p><strong>Name:</strong> ${c.name}</p>
                    <p><strong>Description:</strong> ${c.description}</p>
                    <p><strong>Total Products:</strong> ${c.productCount}</p>
                    <p><strong>Active:</strong> ${c.isActive ? '✅ Active' : '❌ Inactive'}</p>
                    <p><strong>Created At:</strong> ${c.createdAt}</p>
                    <p><strong>Created By:</strong> ${c.createdBy}</p>
                    <p><strong>Updated At:</strong> ${c.updatedAt ?? ''}</p>
                    <p><strong>Updated By:</strong> ${c.updatedBy ?? ''}</p>
                    <hr/>
                    <h6>Products:</h6>
                    ${productsHtml}
                `;

                $('#categoryDetailsBody').html(html);
                new bootstrap.Modal(document.getElementById('categoryDetailsModal')).show();
            });
        }



                // Save (Add/Edit)
        $('#btnSaveCategory').click(function () {
            var category = {
                Id: parseInt($('#categoryId').val()) || 0,
                Name: $('#categoryName').val(),
                Description: $('#categoryDescription').val()
            };

            var isEdit = category.Id > 0;
            var url = isEdit ? '/Categories/Edit' : '/Categories/Create';

            $.ajax({
                type: 'POST',
                url: url,
                data: JSON.stringify(category),
                contentType: 'application/json',
                success: function (response) {
                    if (response.success) {
                        $('#categoryModal').modal('hide');
                        loadCategories();

                        // ✅ Show toast depending on action
                        if (isEdit) {
                            showToast("Category updated successfully!", "success");
                        } else {
                            showToast("Category created successfully!", "success");
                        }
                    } else {
                        showToast("Error: " + (response.error || 'Unknown error'), "error");
                    }
                },
                error: function () {
                    showToast("Unexpected error occurred!", "error");
                }
            });
        });


               

           function showToast(message, type = "success") {
            const toastEl = document.getElementById("liveToast");
            const toastBody = document.getElementById("toastMessage");

            // Reset classes
            toastEl.className = "toast align-items-center border-0 mt-5";

            // Apply dynamic colors
            if (type === "success") {
                toastEl.classList.add("bg-success", "text-white");
            } else if (type === "error") {
                toastEl.classList.add("bg-danger", "text-white");
            } else if (type === "warning") {
                toastEl.classList.add("bg-warning", "text-dark");
            }

            toastBody.innerText = message;
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }



        // Load all categories
               function loadCategories() {
            $.get('/Categories/GetAll', function(data) {
                var tbody = '';
                data.forEach(function(c) {
                    tbody += `<tr id="row_${c.id}">
                        <td>${c.name}</td>
                        <td>${c.description}</td>
                        <td class="text-center">
                        <a href="/Products/ByCategory/${c.id}" class="btn btn-link">${c.productCount || 0}</a>
                        </td>

                        <td class="text-center">
                            <button class="btn btn-info btn-sm me-1" onclick="openCategoryDetailsModal(${c.id})">
                                Details
                            </button>
                            <button class="btn btn-warning btn-sm me-1" onclick="openEditCategoryModal(${c.id}, '${c.name}', '${c.description}')">
                                Edit
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="openDeleteCategoryModal(${c.id})">
                                Delete
                            </button>
                        </td>
                    </tr>`;
                });
                $('#categoryTable tbody').html(tbody);
            });
        }


        $(document).ready(function() {
            loadCategories();
        });
    </script>
}
