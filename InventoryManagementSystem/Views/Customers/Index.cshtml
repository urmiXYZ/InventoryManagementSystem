@{
    ViewData["Title"] = "Customers";
}

<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
    <div id="productToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="productToastBody">
                <!-- Message goes here -->
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0 text-primary">Customers</h2>
    <button class="btn btn-success shadow-sm" id="btnAddCustomer">
        <i class="bi bi-plus-lg"></i> Add Customer
    </button>
</div>


<table class="table table-bordered table-striped" id="customersTable">
    <thead class="table-dark">
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Mobile</th>
            <th>Address</th>
            <th>Is Active</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <!-- Rows loaded by AJAX -->
    </tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerModalTitle">Add Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <input type="hidden" id="customerId" />
                    <div class="mb-3">
                        <label>Name</label>
                        <input type="text" id="Name" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Email</label>
                        <input type="email" id="Email" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label>Mobile</label>
                        <input type="text" id="Mobile" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label>Address</label>
                        <input type="text" id="Address" class="form-control" />
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" id="IsActive" class="form-check-input" checked />
                        <label class="form-check-label">Is Active</label>
                    </div>
                    <button type="submit" class="btn btn-primary" id="btnSave">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this customer?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="btnConfirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Customer Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <dl class="row">

                    <dt class="col-sm-4">Name</dt>
                    <dd class="col-sm-8" id="detailName"></dd>

                    <dt class="col-sm-4">Email</dt>
                    <dd class="col-sm-8" id="detailEmail"></dd>

                    <dt class="col-sm-4">Mobile</dt>
                    <dd class="col-sm-8" id="detailMobile"></dd>

                    <dt class="col-sm-4">Address</dt>
                    <dd class="col-sm-8" id="detailAddress"></dd>

                    <dt class="col-sm-4">Is Active</dt>
                    <dd class="col-sm-8" id="detailIsActive"></dd>

                    <dt class="col-sm-4">Created At</dt>
                    <dd class="col-sm-8" id="detailCreatedAt"></dd>

                    <dt class="col-sm-4">Created By</dt>
                    <dd class="col-sm-8" id="detailCreatedBy"></dd>

                    <dt class="col-sm-4">Updated At</dt>
                    <dd class="col-sm-8" id="detailUpdatedAt"></dd>

                    <dt class="col-sm-4">Updated By</dt>
                    <dd class="col-sm-8" id="detailUpdatedBy"></dd>
                </dl>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            loadCustomers();

            // Load customers
            function loadCustomers() {
                $.get('/Customers/GetAll', function (data) {
                    let rows = '';
                    data.forEach(c => {
                        rows += `<tr class="${c.isActive ? '' : 'table-secondary'}">
                            <td>${c.name}</td>
                            <td>${c.email}</td>
                            <td>${c.mobile}</td>
                            <td>${c.address}</td>
                            <td>${c.isActive ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>'}</td>
                            <td>
                                <button class="btn btn-info btn-sm btnDetails" data-id="${c.id}">Details</button>
                                <button class="btn btn-warning btn-sm btnEdit" data-id="${c.id}">Edit</button>
                                <button class="btn btn-danger btn-sm btnDelete" data-id="${c.id}">Delete</button>
                            </td>
                        </tr>`;
                    });
                    $('#customersTable tbody').html(rows);
                });
            }

            // Add button
            $('#btnAddCustomer').click(function () {
                $('#customerForm')[0].reset();
                $('#customerId').val('');
                $('#customerModalTitle').text('Add Customer');
                $('#customerModal').modal('show');
            });

            $('#customerForm').submit(function (e) {
            e.preventDefault();

            const customer = {
                Id: $('#customerId').val() ? parseInt($('#customerId').val()) : 0,
                Name: $('#Name').val(),
                Email: $('#Email').val(),
                Mobile: $('#Mobile').val(),
                Address: $('#Address').val(),
                IsActive: $('#IsActive').is(':checked')
            };

            const url = customer.Id ? '/Customers/EditAjax' : '/Customers/CreateAjax';
            const isEdit = customer.Id > 0;

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(customer),
                success: function (res) {
                    console.log('Saved:', res);
                    $('#customerModal').modal('hide');
                    loadCustomers();

                    // Show proper toast
                    const msg = isEdit ? 'Customer updated successfully!' : 'Customer added successfully!';
                    showToast(msg, 'success');
                },
                error: function (xhr) {
                    console.error('Error:', xhr.responseText);
                }
            });
        });

            // Edit button
        $(document).on('click', '.btnEdit', function () {
                const id = $(this).data('id');
                $.get('/Customers/Get/' + id, function (c) {
                    $('#customerId').val(c.id);
                    $('#Name').val(c.name);
                    $('#Email').val(c.email);
                    $('#Mobile').val(c.mobile);
                    $('#Address').val(c.address);
                    $('#IsActive').prop('checked', c.isActive);
                    $('#customerModalTitle').text('Edit Customer');
                    $('#customerModal').modal('show');
                });
            });

        let deleteCustomerId = 0; // Store customer id to delete

        // Open modal on delete button click
        $(document).on('click', '.btnDelete', function () {
            deleteCustomerId = $(this).data('id');
            $('#deleteModal').modal('show');
        });

        // Confirm delete
        $('#btnConfirmDelete').click(function () {
            if (deleteCustomerId > 0) {
                $.ajax({
                    url: '/Customers/DeleteAjax/' + deleteCustomerId,
                    type: 'POST',
                    success: function () {
                        $('#deleteModal').modal('hide');
                        loadCustomers();
                                showToast('Customer deleted successfully!', 'danger');

                        deleteCustomerId = 0;
                    },
                    error: function (xhr) {
                        console.error('Delete failed:', xhr.responseText);
                    }
                });
            }
        });


        /// Details button click
        $(document).on('click', '.btnDetails', function () {
            const id = $(this).data('id');
            $.get('/Customers/Get/' + id, function (c) {
                $('#detailName').text(c.name);
                $('#detailEmail').text(c.email);
                $('#detailMobile').text(c.mobile);
                $('#detailAddress').text(c.address);
                $('#detailIsActive').html(c.isActive ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>');
                $('#detailCreatedAt').text(new Date(c.createdAt).toLocaleString());
                $('#detailCreatedBy').text(c.createdBy || '');
                $('#detailUpdatedAt').text(c.updatedAt ? new Date(c.updatedAt).toLocaleString() : '');
                $('#detailUpdatedBy').text(c.updatedBy || '');

                $('#detailsModal').modal('show');
            });
        });

        });

    function showToast(message, type = 'success') {
                const toastEl = document.getElementById('productToast');
                const toastBody = document.getElementById('productToastBody');

                // Reset classes
                toastEl.classList.remove('bg-success', 'bg-danger', 'bg-secondary');

                // Set color based on type
                if(type === 'success') toastEl.classList.add('bg-success');       // Add/Edit
                else if(type === 'danger') toastEl.classList.add('bg-danger');    // Delete
                else if(type === 'secondary') toastEl.classList.add('bg-secondary'); // Inactive

                toastBody.textContent = message;

                const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                toast.show();
            }

    </script>
}
